{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<div class="container" style="padding: var(--space-8) 0;">
  <!-- Modern Header Section -->
  <div class="text-center mb-12 animate-slide-down">
    <div class="d-flex justify-content-center gap-3 mb-4" style="opacity: 0.8;">
      <div class="animate-pulse" style="animation-delay: 0s;">
        <i class="fab fa-docker" style="font-size: var(--font-size-2xl); color: var(--accent-primary);"></i>
      </div>
      <div class="animate-pulse" style="animation-delay: 0.5s;">
        <i class="fas fa-cloud" style="font-size: var(--font-size-2xl); color: var(--accent-primary);"></i>
      </div>
      <div class="animate-pulse" style="animation-delay: 1s;">
        <i class="fas fa-database" style="font-size: var(--font-size-2xl); color: var(--accent-primary);"></i>
      </div>
      <div class="animate-pulse" style="animation-delay: 1.5s;">
        <i class="fas fa-chart-line" style="font-size: var(--font-size-2xl); color: var(--accent-primary);"></i>
      </div>
    </div>
    
    <h1 class="mb-4">Technical Library</h1>
    <p class="text-secondary" style="max-width: 600px; margin: 0 auto;">
      {% if template_data.category %}
        {{ template_data.category.name }} â€¢ Professional technical books and resources for engineers
      {% else %}
        DevOps, Cloud Computing, Data Science, ML & Software Development resources
      {% endif %}
    </p>
    
    <!-- Access Control Status -->
    {% if user.is_authenticated and not access_context.has_content_access %}
      <div class="access-message mt-6">
        <h3>
          <i class="fas fa-lock"></i>
          Content Access Required
        </h3>
        <p>You can browse books, but viewing details and downloading PDFs requires admin approval.</p>
        {% if access_context.can_request_access %}
          <div class="mt-4">
            <a href="{% url 'accounts.access_status' %}" class="btn-request-access" onclick="this.innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> Loading...'; this.style.pointerEvents='none';">
              <i class="fas fa-key"></i>
              Request Access
            </a>
          </div>
        {% endif %}
      </div>
    {% elif user.is_authenticated and access_context.has_content_access %}
      <div class="access-message approved mt-6">
        <h3>
          <i class="fas fa-check-circle"></i>
          Full Access Granted
        </h3>
        <p>You have full access to view, preview, and download all technical content.</p>
      </div>
    {% endif %}
  </div>

  <!-- Enhanced Search Section -->
  <div class="animate-slide-up animate-stagger-1 mb-10">
    <div class="text-center" style="max-width: 500px; margin: 0 auto;">
      <form method="GET" class="d-flex">
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
          <div class="d-flex align-items-center gap-3" style="background-color: var(--bg-surface); border: 1px solid var(--border-default); border-radius: var(--radius-xl); padding: var(--space-2) var(--space-4); transition: all var(--transition-fast);">
            <i class="fas fa-search text-muted"></i>
            <input type="text" name="search" class="form-control" placeholder="Search technical books... (Press / to focus)" 
                   value="{{ template_data.search_term|default:'' }}"
                   style="background: transparent; border: none; outline: none; padding: 0;">
            <button type="submit" class="btn btn-primary btn-sm">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modern Category Navigation -->
  {% if template_data.categories %}
  <div class="category-navigation animate-slide-up animate-stagger-2">
    <div class="category-scroll">
      <a href="{% url 'books.index' %}" class="category-chip {% if not template_data.category %}active{% endif %}">
        <i class="fas fa-th-large"></i>
        <span>All Books</span>
      </a>
      {% for category in template_data.categories %}
        <a href="{% url 'books.category' category.slug %}" 
           class="category-chip {% if template_data.category.id == category.id %}active{% endif %}">
          {% if 'devops' in category.name|lower or 'ops' in category.name|lower %}
            <i class="fas fa-cogs"></i>
          {% elif 'cloud' in category.name|lower %}
            <i class="fas fa-cloud"></i>
          {% elif 'data' in category.name|lower %}
            <i class="fas fa-chart-bar"></i>
          {% elif 'machine' in category.name|lower or 'ml' in category.name|lower or 'ai' in category.name|lower %}
            <i class="fas fa-robot"></i>
          {% elif 'software' in category.name|lower or 'development' in category.name|lower or 'programming' in category.name|lower %}
            <i class="fas fa-code"></i>
          {% elif 'database' in category.name|lower or 'sql' in category.name|lower %}
            <i class="fas fa-database"></i>
          {% elif 'observability' in category.name|lower or 'monitoring' in category.name|lower %}
            <i class="fas fa-chart-line"></i>
          {% else %}
            <i class="fas fa-book"></i>
          {% endif %}
          <span>{{ category.name }}</span>
        </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Modern Books Grid -->
  <div class="books-section">
    {% if template_data.books %}
      <div class="books-grid">
        {% for book in template_data.books %}
          <div class="book-card animate-slide-up animate-stagger-{{ forloop.counter }}" data-book-url="{% url 'books.show' book.id %}">
            
            <!-- Book Cover -->
            <div class="book-cover">
              {% if book.cover %}
                <img src="{{ book.cover.url }}" 
                     alt="{{ book.name }}" 
                     loading="lazy"
                     decoding="async"
                     fetchpriority="{% if forloop.counter <= 4 %}high{% else %}low{% endif %}">
              {% else %}
                <div class="book-cover-placeholder">
                  <i class="fas fa-file-code"></i>
                  <span>Technical Book</span>
                </div>
              {% endif %}
            </div>
            
            <!-- Book Info -->
            <div class="book-info">
              <div>
                <h4 class="book-title">
                  <a href="{% url 'books.show' book.id %}">{{ book.name }}</a>
                </h4>
                <p class="book-author">{{ book.author|default:"Technical Author" }}</p>
                
                {% if book.category %}
                  <div class="book-category">
                    {% if 'devops' in book.category.name|lower %}
                      <i class="fas fa-cogs"></i>
                    {% elif 'cloud' in book.category.name|lower %}
                      <i class="fas fa-cloud"></i>
                    {% elif 'data' in book.category.name|lower %}
                      <i class="fas fa-chart-bar"></i>
                    {% elif 'machine' in book.category.name|lower %}
                      <i class="fas fa-robot"></i>
                    {% elif 'software' in book.category.name|lower %}
                      <i class="fas fa-code"></i>
                    {% elif 'database' in book.category.name|lower %}
                      <i class="fas fa-database"></i>
                    {% else %}
                      <i class="fas fa-book"></i>
                    {% endif %}
                    {{ book.category.name }}
                  </div>
                {% endif %}
              </div>
              
              <!-- Action Button - Enhanced -->
              {% if user.is_authenticated %}
                <div class="book-actions">
                  {% if access_context.has_content_access %}
                    {% if book.id in template_data.user_library_book_ids %}
                      <button class="library-toggle-btn in-library remove-from-library" data-book-id="{{ book.id }}" data-book-title="{{ book.name }}">
                        <i class="fas fa-check-circle"></i>
                        <span>In Library</span>
                      </button>
                    {% else %}
                      <button class="library-toggle-btn add-to-library" data-book-id="{{ book.id }}" data-book-title="{{ book.name }}">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add to Library</span>
                      </button>
                    {% endif %}
                  {% else %}
                    <button class="library-toggle-btn disabled" disabled title="Access approval required">
                      <i class="fas fa-lock"></i>
                      <span>Access Required</span>
                    </button>
                  {% endif %}
                </div>
              {% else %}
                <div class="book-actions">
                  <a href="{% url 'accounts.login' %}" class="library-toggle-btn signin-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In to Add</span>
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Modern Pagination -->
      {% if template_data.books.has_other_pages %}
        <div class="d-flex align-items-center justify-content-center gap-4 mt-12">
          {% if template_data.books.has_previous %}
            <a href="?page={{ template_data.books.previous_page_number }}{% if template_data.search_term %}&search={{ template_data.search_term }}{% endif %}" 
               class="btn btn-secondary">
              <i class="fas fa-chevron-left"></i>
              Previous
            </a>
          {% endif %}
          
          <span class="text-secondary">
            Page {{ template_data.books.number }} of {{ template_data.books.paginator.num_pages }}
          </span>
          
          {% if template_data.books.has_next %}
            <a href="?page={{ template_data.books.next_page_number }}{% if template_data.search_term %}&search={{ template_data.search_term }}{% endif %}" 
               class="btn btn-secondary">
              Next
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <!-- Modern Empty State -->
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-search"></i>
        </div>
        <h3 class="mb-3">No Technical Books Found</h3>
        <p class="text-secondary mb-6" style="max-width: 400px; margin-left: auto; margin-right: auto;">
          {% if template_data.search_term %}
            No books match your search "{{ template_data.search_term }}". Try different keywords or browse categories.
          {% else %}
            No books available in this category yet. Check back for new technical resources.
          {% endif %}
        </p>
        {% if template_data.search_term %}
          <a href="{% url 'books.index' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i>
            View All Books
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script>
// Enhanced Books page functionality
document.addEventListener('DOMContentLoaded', function() {
  // Animate elements on scroll
  const animateElements = document.querySelectorAll('[class*="animate-"]');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.animationPlayState = 'running';
      }
    });
  }, { threshold: 0.1 });
  
  animateElements.forEach(el => {
    observer.observe(el);
  });
  
  // Enhanced book card interactions
  const bookCards = document.querySelectorAll('.book-card[data-book-url]');
  bookCards.forEach(card => {
    card.addEventListener('click', function(e) {
      if (e.target.closest('.book-actions') || e.target.closest('.btn')) {
        return;
      }
      window.location.href = this.dataset.bookUrl;
    });
    
    // Keyboard support
    card.setAttribute('tabindex', '0');
    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });
  
  // Enhanced search functionality
  const searchInput = document.querySelector('input[name="search"]');
  if (searchInput) {
    // Focus search on '/' key
    document.addEventListener('keydown', function(e) {
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        searchInput.focus();
      }
    });
    
    // Clear search on Escape
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        this.value = '';
        this.blur();
      }
    });
  }
});
</script>
{% endblock content %}