{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<div class="container book-detail">
  <!-- Book Header -->
  <div class="book-header">
    <div class="book-cover-large">
      {% if template_data.book.cover %}
        <img src="{{ template_data.book.cover.url }}" alt="{{ template_data.book.name }}">
      {% else %}
        <div class="book-cover-large-placeholder">
          <i class="fas fa-file-code"></i>
          <div class="placeholder-text">Technical Book</div>
        </div>
      {% endif %}
    </div>
    
    <div class="book-meta-detail">
      <h1 class="book-title-large">{{ template_data.book.name }}</h1>
      <p class="book-author-large">{{ template_data.book.author|default:"Technical Author" }}</p>
      
      <div class="book-actions">
        {% if user.is_authenticated %}
          {% if template_data.is_in_library %}
            <button class="btn btn-danger remove-from-library" data-book-id="{{ template_data.book.id }}">
              <i class="fas fa-bookmark-slash"></i>
              Remove from Library
            </button>
          {% else %}
            <button class="btn btn-primary add-to-library" data-book-id="{{ template_data.book.id }}">
              <i class="fas fa-bookmark"></i>
              Add to Library
            </button>
          {% endif %}
          {% if template_data.book.pdf %}
            <a href="{% url 'books.view' template_data.book.id %}" class="btn btn-secondary" target="_blank">
              <i class="fas fa-external-link-alt"></i>
              Read PDF
            </a>
            <a href="{% url 'books.download' template_data.book.id %}" class="btn btn-secondary">
              <i class="fas fa-download"></i>
              Download
            </a>
          {% endif %}
        {% else %}
          <a href="{% url 'accounts.login' %}?next={{ request.path }}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            Sign In to Access
          </a>
        {% endif %}
      </div>
      
      {% if template_data.book.description %}
        <div class="book-description">
          <p>{{ template_data.book.description }}</p>
        </div>
      {% endif %}
      
      <!-- Book Metadata -->
      <div class="book-metadata-grid">
        {% if template_data.book.category %}
          <div class="metadata-item">
            <div class="metadata-label">Category</div>
            <div class="metadata-value">
              <a href="{% url 'books.category' template_data.book.category.slug %}" 
                 style="color: var(--accent-primary); display: flex; align-items: center; gap: var(--space-2);">
                {% if 'devops' in template_data.book.category.name|lower %}
                  <i class="fas fa-cogs"></i>
                {% elif 'cloud' in template_data.book.category.name|lower %}
                  <i class="fas fa-cloud"></i>
                {% elif 'data' in template_data.book.category.name|lower %}
                  <i class="fas fa-chart-bar"></i>
                {% elif 'machine' in template_data.book.category.name|lower %}
                  <i class="fas fa-robot"></i>
                {% elif 'software' in template_data.book.category.name|lower %}
                  <i class="fas fa-code"></i>
                {% elif 'database' in template_data.book.category.name|lower %}
                  <i class="fas fa-database"></i>
                {% elif 'observability' in template_data.book.category.name|lower %}
                  <i class="fas fa-chart-line"></i>
                {% else %}
                  <i class="fas fa-book"></i>
                {% endif %}
                {{ template_data.book.category.name }}
              </a>
            </div>
          </div>
        {% endif %}
        
        {% if template_data.book.pdf %}
          <div class="metadata-item">
            <div class="metadata-label">Format</div>
            <div class="metadata-value">
              <span style="color: var(--accent-primary); display: flex; align-items: center; gap: var(--space-2);">
                <i class="fas fa-file-pdf"></i> PDF Document
              </span>
            </div>
          </div>
        {% endif %}
        
        <div class="metadata-item">
          <div class="metadata-label">Target Audience</div>
          <div class="metadata-value">Developers & Engineers</div>
        </div>
        
        <div class="metadata-item">
          <div class="metadata-label">Access Level</div>
          <div class="metadata-value">
            {% if user.is_authenticated %}
              <span style="color: var(--success); display: flex; align-items: center; gap: var(--space-2);">
                <i class="fas fa-check-circle"></i> Full Access
              </span>
            {% else %}
              <span style="color: var(--warning); display: flex; align-items: center; gap: var(--space-2);">
                <i class="fas fa-lock"></i> Sign In Required
              </span>
            {% endif %}
          </div>
        </div>
        
        {% if template_data.is_in_library %}
          <div class="metadata-item library-status-item">
            <div class="metadata-label">Library Status</div>
            <div class="metadata-value">
              <span style="color: var(--success); display: flex; align-items: center; gap: var(--space-2);">
                <i class="fas fa-bookmark"></i> In Your Library
              </span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Reviews Section -->
  <div class="section">
    <h2 class="mb-6">Technical Reviews</h2>
    
    {% if template_data.reviews %}
      <div class="reviews-list" style="margin-bottom: var(--space-8);">
        {% for review in template_data.reviews %}
          <div class="card mb-4">
            <div class="card-body">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h5 style="margin-bottom: var(--space-1); display: flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-user-circle" style="color: var(--accent-primary);"></i>
                    {{ review.user.username }}
                  </h5>
                  <p style="color: var(--text-tertiary); font-size: var(--font-size-sm); margin: 0;">
                    {{ review.date|date:"M d, Y" }}
                  </p>
                </div>
                {% if user.is_authenticated and user == review.user %}
                  <div class="flex gap-2">
                    <a href="{% url 'books.edit_review' template_data.book.id review.id %}" 
                       class="btn btn-ghost btn-sm">
                      <i class="fas fa-edit"></i>
                      Edit
                    </a>
                    <a href="{% url 'books.delete_review' template_data.book.id review.id %}" 
                       class="btn btn-ghost btn-sm" 
                       onclick="return confirm('Delete this review?')">
                      <i class="fas fa-trash"></i>
                      Delete
                    </a>
                  </div>
                {% endif %}
              </div>
              <p style="color: var(--text-secondary);">{{ review.comment }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center" style="padding: var(--space-8) 0; margin-bottom: var(--space-8);">
        <i class="fas fa-comments" style="font-size: 2rem; color: var(--text-muted); margin-bottom: var(--space-3);"></i>
        <p style="color: var(--text-tertiary);">No technical reviews yet. Be the first to review this book!</p>
      </div>
    {% endif %}

    <!-- Add Review Form -->
    {% if user.is_authenticated %}
      <div class="card">
        <div class="card-header">
          <h4 style="display: flex; align-items: center; gap: var(--space-2);">
            <i class="fas fa-star" style="color: var(--accent-primary);"></i>
            Write a Technical Review
          </h4>
        </div>
        <div class="card-body">
          <form method="POST" action="{% url 'books.create_review' template_data.book.id %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="comment" class="form-label">Your Technical Review</label>
              <textarea name="comment" id="comment" class="form-control" rows="4" 
                        placeholder="Share your technical insights about this book - content quality, practical examples, technical depth..." required></textarea>
            </div>
            <div class="text-right">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Submit Review
              </button>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <div class="card">
        <div class="card-body text-center">
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
            Sign in to write a technical review for this book.
          </p>
          <a href="{% url 'accounts.login' %}?next={{ request.path }}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            Sign In
          </a>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Navigation -->
  <div class="section">
    <div class="flex justify-between">
      {% if template_data.category %}
        <a href="{% url 'books.category' template_data.category.slug %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to {{ template_data.category.name }}
        </a>
      {% else %}
        <a href="{% url 'books.index' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to Technical Library
        </a>
      {% endif %}
      
      <a href="{% url 'books.index' %}" class="btn btn-ghost">
        <i class="fas fa-th"></i>
        Browse All Technical Books
      </a>
    </div>
  </div>
</div>

<script>
// Book detail page specific functionality
document.addEventListener('DOMContentLoaded', function() {
  console.log('Book detail page loaded');
  
  // The LibraryManager handles all add/remove functionality
  // No additional JavaScript needed for this page
});
// Helper functions
function getCsrfToken() {
  // First try to get from form
  const token = document.querySelector('[name=csrfmiddlewaretoken]');
  if (token) {
    return token.value;
  }
  
  // Try to get from meta tag
  const metaToken = document.querySelector('meta[name="csrf-token"]');
  if (metaToken) {
    return metaToken.getAttribute('content');
  }
  
  // Fallback: try to get from cookie
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  
  console.error('CSRF token not found');
  return '';
}

function showNotification(message, type) {
  // Remove any existing notifications first to prevent duplicates
  const existingNotifications = document.querySelectorAll('.notification-toast');
  existingNotifications.forEach(notification => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  });
  
  // Create notification element
  const notification = document.createElement('div');
  notification.className = 'notification-toast';
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
    color: white;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 1001;
    font-size: var(--font-size-sm);
    font-weight: 500;
    max-width: 300px;
    opacity: 0;
    transform: translateX(100%);
    transition: all var(--transition-smooth);
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.opacity = '1';
    notification.style.transform = 'translateX(0)';
  }, 10);
  
  // Remove after 3 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.opacity = '0';
});

// All library management functions are now handled by the shared LibraryManager
</script>
{% endblock content %}