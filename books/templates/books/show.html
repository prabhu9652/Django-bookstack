{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container book-detail">
  <!-- Book Header -->
  <div class="book-header">
    <div class="book-cover-large">
      {% if template_data.book.cover %}
        <img src="{{ template_data.book.cover.url }}" alt="{{ template_data.book.name }}">
      {% else %}
        <i class="fas fa-book"></i>
      {% endif %}
    </div>
    
    <div class="book-meta">
      <h1 class="book-title-large">{{ template_data.book.name }}</h1>
      <p class="book-author-large">{{ template_data.book.author|default:"Unknown Author" }}</p>
      
      <div class="book-actions">
        {% if user.is_authenticated %}
          <button class="btn btn-primary add-to-library" data-book-id="{{ template_data.book.id }}">
            <i class="fas fa-bookmark"></i>
            Add to Library
          </button>
          {% if template_data.book.pdf %}
            <a href="{% url 'books.view' template_data.book.id %}" class="btn btn-secondary" target="_blank">
              <i class="fas fa-eye"></i>
              Read
            </a>
            <a href="{% url 'books.download' template_data.book.id %}" class="btn btn-secondary">
              <i class="fas fa-download"></i>
              Download
            </a>
          {% endif %}
        {% else %}
          <a href="{% url 'accounts.login' %}?next={{ request.path }}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            Sign In to Access
          </a>
        {% endif %}
      </div>
      
      {% if template_data.book.description %}
        <div class="book-description">
          <p>{{ template_data.book.description }}</p>
        </div>
      {% endif %}
      
      <!-- Book Metadata -->
      <div class="book-metadata" style="margin-top: var(--space-4);">
        {% if template_data.book.category %}
          <div style="margin-bottom: var(--space-2);">
            <span style="color: var(--text-tertiary); font-size: var(--font-size-sm);">Category:</span>
            <a href="{% url 'books.category' template_data.book.category.slug %}" 
               style="color: var(--accent-primary); margin-left: var(--space-2);">
              {{ template_data.book.category.name }}
            </a>
          </div>
        {% endif %}
        
        {% if template_data.book.price %}
          <div style="margin-bottom: var(--space-2);">
            <span style="color: var(--text-tertiary); font-size: var(--font-size-sm);">Price:</span>
            <span style="color: var(--text-secondary); margin-left: var(--space-2);">${{ template_data.book.price }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- PDF Viewer -->
  {% if user.is_authenticated and template_data.book.pdf %}
    <div class="section">
      <h2 class="mb-4">Preview</h2>
      <div class="pdf-viewer">
        <iframe src="{% url 'books.view' template_data.book.id %}" 
                title="Book Preview - {{ template_data.book.name }}">
        </iframe>
      </div>
    </div>
  {% endif %}

  <!-- Reviews Section -->
  <div class="section">
    <h2 class="mb-6">Reviews</h2>
    
    {% if template_data.reviews %}
      <div class="reviews-list" style="margin-bottom: var(--space-8);">
        {% for review in template_data.reviews %}
          <div class="card mb-4">
            <div class="card-body">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h5 style="margin-bottom: var(--space-1);">{{ review.user.username }}</h5>
                  <p style="color: var(--text-tertiary); font-size: var(--font-size-sm); margin: 0;">
                    {{ review.date|date:"M d, Y" }}
                  </p>
                </div>
                {% if user.is_authenticated and user == review.user %}
                  <div class="flex gap-2">
                    <a href="{% url 'books.edit_review' template_data.book.id review.id %}" 
                       class="btn btn-ghost btn-sm">
                      <i class="fas fa-edit"></i>
                      Edit
                    </a>
                    <a href="{% url 'books.delete_review' template_data.book.id review.id %}" 
                       class="btn btn-ghost btn-sm" 
                       onclick="return confirm('Delete this review?')">
                      <i class="fas fa-trash"></i>
                      Delete
                    </a>
                  </div>
                {% endif %}
              </div>
              <p style="color: var(--text-secondary);">{{ review.comment }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center" style="padding: var(--space-8) 0; margin-bottom: var(--space-8);">
        <i class="fas fa-comments" style="font-size: 2rem; color: var(--text-muted); margin-bottom: var(--space-3);"></i>
        <p style="color: var(--text-tertiary);">No reviews yet. Be the first to review this book!</p>
      </div>
    {% endif %}

    <!-- Add Review Form -->
    {% if user.is_authenticated %}
      <div class="card">
        <div class="card-header">
          <h4>Write a Review</h4>
        </div>
        <div class="card-body">
          <form method="POST" action="{% url 'books.create_review' template_data.book.id %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="comment" class="form-label">Your Review</label>
              <textarea name="comment" id="comment" class="form-control" rows="4" 
                        placeholder="Share your thoughts about this book..." required></textarea>
            </div>
            <div class="text-right">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Submit Review
              </button>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <div class="card">
        <div class="card-body text-center">
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
            Sign in to write a review for this book.
          </p>
          <a href="{% url 'accounts.login' %}?next={{ request.path }}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i>
            Sign In
          </a>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Navigation -->
  <div class="section">
    <div class="flex justify-between">
      {% if template_data.category %}
        <a href="{% url 'books.category' template_data.category.slug %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to {{ template_data.category.name }}
        </a>
      {% else %}
        <a href="{% url 'books.index' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to Library
        </a>
      {% endif %}
      
      <a href="{% url 'books.index' %}" class="btn btn-ghost">
        <i class="fas fa-th"></i>
        Browse All Books
      </a>
    </div>
  </div>
</div>
{% endblock content %}