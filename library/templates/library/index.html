{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <!-- Library Header -->
  <div class="library-header">
    <h1>My Library</h1>
    <div class="flex items-center gap-4">
      <span style="color: var(--text-secondary);">
        {{ template_data.total_books }} book{{ template_data.total_books|pluralize }}
      </span>
      <a href="{% url 'books.index' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Books
      </a>
    </div>
  </div>

  <!-- Category Filters -->
  <div class="library-categories">
    <a href="{% url 'library.index' %}" 
       class="library-category {% if not template_data.current_category %}active{% endif %}">
      <i class="fas fa-th-large"></i>
      All Books ({{ template_data.total_books }})
    </a>
    
    {% for category in template_data.categories %}
      <a href="{% url 'library.index' %}?category={{ category.slug }}" 
         class="library-category {% if template_data.current_category == category.slug %}active{% endif %}">
        <i class="fas fa-folder"></i>
        {{ category.name }} ({{ category.books.count }})
      </a>
    {% endfor %}
    
    {% if template_data.uncategorized_count > 0 %}
      <a href="{% url 'library.index' %}?category=uncategorized" 
         class="library-category {% if template_data.current_category == 'uncategorized' %}active{% endif %}">
        <i class="fas fa-question-circle"></i>
        Uncategorized ({{ template_data.uncategorized_count }})
      </a>
    {% endif %}
  </div>

  <!-- Library Books -->
  <div class="section">
    {% if template_data.library_books %}
      <div class="library-books">
        {% for library_item in template_data.library_books %}
          <div class="book-card library-book" data-category="{{ library_item.book.category.slug|default:'uncategorized' }}">
            <div class="book-cover">
              {% if library_item.book.cover %}
                <img src="{{ library_item.book.cover.url }}" alt="{{ library_item.book.name }}">
              {% else %}
                <i class="fas fa-book"></i>
              {% endif %}
            </div>
            <div class="book-info">
              <h4 class="book-title">
                <a href="{% url 'books.show' library_item.book.id %}" style="color: inherit; text-decoration: none;">
                  {{ library_item.book.name }}
                </a>
              </h4>
              <p class="book-author">{{ library_item.book.author|default:"Unknown Author" }}</p>
              {% if library_item.book.category %}
                <span class="book-category">{{ library_item.book.category.name }}</span>
              {% endif %}
              <div style="margin-top: var(--space-3);">
                <small style="color: var(--text-tertiary);">
                  Added {{ library_item.added_date|date:"M d, Y" }}
                </small>
              </div>
              
              <!-- Book Actions -->
              <div class="flex gap-2 mt-3">
                <a href="{% url 'books.show' library_item.book.id %}" class="btn btn-primary btn-sm">
                  <i class="fas fa-eye"></i>
                  View
                </a>
                {% if library_item.book.pdf %}
                  <a href="{% url 'books.view' library_item.book.id %}" class="btn btn-secondary btn-sm" target="_blank">
                    <i class="fas fa-book-open"></i>
                    Read
                  </a>
                  <a href="{% url 'books.download' library_item.book.id %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-download"></i>
                    Download
                  </a>
                {% endif %}
                <button class="btn btn-ghost btn-sm remove-from-library" data-book-id="{{ library_item.book.id }}">
                  <i class="fas fa-trash"></i>
                  Remove
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty Library State -->
      <div class="text-center" style="padding: var(--space-16) 0;">
        <i class="fas fa-bookmark" style="font-size: 4rem; color: var(--text-muted); margin-bottom: var(--space-4);"></i>
        <h3 style="color: var(--text-secondary); margin-bottom: var(--space-2);">Your library is empty</h3>
        <p style="color: var(--text-tertiary); margin-bottom: var(--space-6);">
          {% if template_data.current_category %}
            No books in this category yet. Browse our collection to add books to your library.
          {% else %}
            Start building your personal library by adding books you're interested in.
          {% endif %}
        </p>
        <a href="{% url 'books.index' %}" class="btn btn-primary">
          <i class="fas fa-search"></i>
          Browse Books
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Remove from library functionality
document.addEventListener('DOMContentLoaded', function() {
  const removeButtons = document.querySelectorAll('.remove-from-library');
  
  removeButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!confirm('Remove this book from your library?')) {
        return;
      }
      
      const bookId = this.dataset.bookId;
      const bookCard = this.closest('.book-card');
      
      // Show loading state
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
      
      fetch('/library/remove/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({ book_id: bookId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the book card with animation
          bookCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          bookCard.style.opacity = '0';
          bookCard.style.transform = 'scale(0.9)';
          
          setTimeout(() => {
            bookCard.remove();
            
            // Check if library is now empty
            const remainingBooks = document.querySelectorAll('.library-book');
            if (remainingBooks.length === 0) {
              location.reload(); // Reload to show empty state
            }
          }, 300);
          
          // Show notification
          if (window.minimalUI) {
            window.minimalUI.showNotification(data.message, 'success');
          }
        } else {
          // Reset button state
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-trash"></i> Remove';
          
          // Show error notification
          if (window.minimalUI) {
            window.minimalUI.showNotification(data.message || 'Failed to remove book', 'error');
          }
        }
      })
      .catch(error => {
        // Reset button state
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-trash"></i> Remove';
        
        // Show error notification
        if (window.minimalUI) {
          window.minimalUI.showNotification('Network error. Please try again.', 'error');
        }
      });
    });
  });
});
</script>
{% endblock content %}