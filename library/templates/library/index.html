{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

<div class="container">
  <!-- Technical Library Header -->
  <div class="tech-header">
    <div class="tech-header-content">
      <div class="tech-icon-group">
        <div class="tech-icon">
          <i class="fas fa-server"></i>
        </div>
        <div class="tech-icon">
          <i class="fas fa-database"></i>
        </div>
        <div class="tech-icon">
          <i class="fas fa-code"></i>
        </div>
        <div class="tech-icon">
          <i class="fas fa-chart-line"></i>
        </div>
      </div>
      <h1 class="tech-title">My Technical Library</h1>
      <p class="tech-subtitle">
        {{ template_data.total_books }} technical book{{ template_data.total_books|pluralize }} in your personal collection
      </p>
    </div>
    <div class="tech-header-actions" style="margin-left: auto !important; display: flex !important; align-items: center !important;">
      <a href="{% url 'books.index' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Technical Books
      </a>
    </div>
  </div>

  <!-- Technical Category Navigation -->
  <div class="tech-category-nav">
    <div class="category-scroll">
      <a href="{% url 'library.index' %}" 
         class="tech-category-item {% if not template_data.current_category %}active{% endif %}">
        <i class="fas fa-th-large"></i>
        <span>All Books ({{ template_data.total_books }})</span>
      </a>
      
      {% for category in template_data.categories %}
        <a href="{% url 'library.index' %}?category={{ category.slug }}" 
           class="tech-category-item {% if template_data.current_category == category.slug %}active{% endif %}">
          {% if category.slug == 'devops' %}
            <i class="fas fa-cogs"></i>
          {% elif category.slug == 'cloud-computing' %}
            <i class="fas fa-cloud"></i>
          {% elif category.slug == 'data-science' %}
            <i class="fas fa-chart-bar"></i>
          {% elif category.slug == 'machine-learning' %}
            <i class="fas fa-brain"></i>
          {% elif category.slug == 'software-development' %}
            <i class="fas fa-code"></i>
          {% elif category.slug == 'observability' %}
            <i class="fas fa-eye"></i>
          {% elif category.slug == 'databases' %}
            <i class="fas fa-database"></i>
          {% else %}
            <i class="fas fa-folder"></i>
          {% endif %}
          <span>{{ category.name }} ({{ category.books.count }})</span>
        </a>
      {% endfor %}
      
      {% if template_data.uncategorized_count > 0 %}
        <a href="{% url 'library.index' %}?category=uncategorized" 
           class="tech-category-item {% if template_data.current_category == 'uncategorized' %}active{% endif %}">
          <i class="fas fa-question-circle"></i>
          <span>Uncategorized ({{ template_data.uncategorized_count }})</span>
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Technical Books Grid -->
  <div class="tech-books-section">
    {% if template_data.library_books %}
      <div class="tech-books-grid">
        {% for library_item in template_data.library_books %}
          <div class="tech-book-card library-book" data-category="{{ library_item.book.category.slug|default:'uncategorized' }}" data-book-id="{{ library_item.book.id }}">
            <!-- Remove Button -->
            <button type="button" 
                    class="library-remove-btn" 
                    data-book-id="{{ library_item.book.id }}" 
                    title="Remove from library"
                    aria-label="Remove {{ library_item.book.name }} from library">
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            
            <div class="tech-book-cover">
              {% if library_item.book.cover %}
                <img src="{{ library_item.book.cover.url }}" alt="{{ library_item.book.name }}" loading="lazy">
              {% else %}
                <div class="tech-book-placeholder">
                  <i class="fas fa-file-pdf"></i>
                  <div class="placeholder-text">Technical Book</div>
                </div>
              {% endif %}
            </div>
            
            <div class="tech-book-info">
              <div class="tech-book-meta">
                {% if library_item.book.category %}
                  <span class="tech-category-badge">
                    {% if library_item.book.category.slug == 'devops' %}
                      <i class="fas fa-cogs"></i>
                    {% elif library_item.book.category.slug == 'cloud-computing' %}
                      <i class="fas fa-cloud"></i>
                    {% elif library_item.book.category.slug == 'data-science' %}
                      <i class="fas fa-chart-bar"></i>
                    {% elif library_item.book.category.slug == 'machine-learning' %}
                      <i class="fas fa-brain"></i>
                    {% elif library_item.book.category.slug == 'software-development' %}
                      <i class="fas fa-code"></i>
                    {% elif library_item.book.category.slug == 'observability' %}
                      <i class="fas fa-eye"></i>
                    {% elif library_item.book.category.slug == 'databases' %}
                      <i class="fas fa-database"></i>
                    {% else %}
                      <i class="fas fa-folder"></i>
                    {% endif %}
                    {{ library_item.book.category.name }}
                  </span>
                {% endif %}
              </div>
              
              <h3 class="tech-book-title">
                <a href="{% url 'books.show' library_item.book.id %}" style="color: inherit; text-decoration: none;">
                  {{ library_item.book.name }}
                </a>
              </h3>
              
              <p class="tech-book-author">{{ library_item.book.author|default:"Technical Author" }}</p>
              
              <!-- Book Actions -->
              <div class="tech-book-actions">
                <a href="{% url 'books.show' library_item.book.id %}" class="btn btn-primary btn-sm">
                  <i class="fas fa-eye"></i>
                  View Details
                </a>
                {% if library_item.book.pdf %}
                  <a href="{% url 'books.view' library_item.book.id %}" class="btn btn-secondary btn-sm" target="_blank">
                    <i class="fas fa-book-open"></i>
                    Read PDF
                  </a>
                {% endif %}
              </div>
              
              <div class="tech-added-date">
                <i class="fas fa-calendar-plus"></i>
                Added {{ library_item.added_date|date:"M d, Y" }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <!-- Empty Technical Library State -->
      <div class="tech-empty-state">
        <div class="empty-icon">
          <i class="fas fa-server"></i>
        </div>
        <h3>Your technical library is empty</h3>
        <p>
          {% if template_data.current_category %}
            No technical books in this category yet. Browse our collection to add books to your library.
          {% else %}
            Start building your technical library with books on DevOps, Cloud Computing, Data Science, and more.
          {% endif %}
        </p>
        <a href="{% url 'books.index' %}" class="btn btn-primary">
          <i class="fas fa-search"></i>
          Browse Technical Books
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Library page specific functionality
document.addEventListener('DOMContentLoaded', function() {
  console.log('My Library page loaded');
  
  // The LibraryManager handles all add/remove functionality
  // This script only handles library-specific UI interactions
  
  // Handle book card navigation (prevent when clicking remove buttons)
  const bookCards = document.querySelectorAll('.tech-book-card');
  bookCards.forEach(card => {
    card.addEventListener('click', function(e) {
      // Don't navigate if clicking on remove button
      if (e.target.closest('.library-remove-btn')) {
        return;
      }
      
      // Navigate to book detail page
      const bookLink = this.querySelector('.tech-book-title a');
      if (bookLink) {
        window.location.href = bookLink.href;
      }
    });
    
    // Add keyboard support
    card.setAttribute('tabindex', '0');
    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });
});
</script>
{% endblock content %}