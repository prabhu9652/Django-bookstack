{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container p-8">
  <div class="access-denied-section text-center">
    <!-- Access Denied Icon -->
    <div class="access-denied-icon mb-6">
      <i class="fas fa-lock"></i>
    </div>
    
    <h1 class="mb-4">Access Approval Required</h1>
    
    {% if user.is_authenticated %}
      {% if access_context.access_status %}
        {% if access_context.access_status.is_pending %}
          <div class="status-card pending-card mb-6">
            <div class="status-icon">
              <i class="fas fa-clock"></i>
            </div>
            <h3>Your Access is Pending</h3>
            <p>Your account has been created successfully, but access to content requires administrator approval.</p>
            <div class="status-details">
              <p><strong>Status:</strong> {{ access_context.access_status_display }}</p>
              <p><strong>Requested:</strong> {{ access_context.access_status.requested_at|date:"M d, Y g:i A" }}</p>
            </div>
          </div>
          
          <div class="action-section">
            <p class="mb-4">You can request access to view and download technical content.</p>
            <button id="requestAccessBtn" class="btn btn-primary btn-lg">
              <i class="fas fa-paper-plane"></i>
              Request Access
            </button>
          </div>
          
        {% elif access_context.access_status.is_rejected %}
          <div class="status-card rejected-card mb-6">
            <div class="status-icon">
              <i class="fas fa-times-circle"></i>
            </div>
            <h3>Access Request Rejected</h3>
            <p>Your access request has been reviewed and rejected by an administrator.</p>
            {% if access_context.access_status.rejection_reason %}
              <div class="rejection-reason">
                <strong>Reason:</strong> {{ access_context.access_status.rejection_reason }}
              </div>
            {% endif %}
            <div class="status-details">
              <p><strong>Requested:</strong> {{ access_context.access_status.requested_at|date:"M d, Y g:i A" }}</p>
            </div>
          </div>
          
          <div class="action-section">
            <p class="mb-4">You can submit a new access request if your circumstances have changed.</p>
            <button id="requestAccessBtn" class="btn btn-primary btn-lg">
              <i class="fas fa-paper-plane"></i>
              Request Access Again
            </button>
          </div>
          
        {% elif access_context.access_status.is_suspended %}
          <div class="status-card suspended-card mb-6">
            <div class="status-icon">
              <i class="fas fa-ban"></i>
            </div>
            <h3>Access Suspended</h3>
            <p>Your access to content has been suspended by an administrator.</p>
            {% if access_context.access_status.rejection_reason %}
              <div class="suspension-reason">
                <strong>Reason:</strong> {{ access_context.access_status.rejection_reason }}
              </div>
            {% endif %}
          </div>
          
          <div class="contact-section">
            <p>If you believe this is an error, please contact the administrator.</p>
          </div>
        {% endif %}
      {% else %}
        <div class="status-card pending-card mb-6">
          <div class="status-icon">
            <i class="fas fa-user-plus"></i>
          </div>
          <h3>Account Setup Required</h3>
          <p>Your account needs to be set up for content access.</p>
        </div>
        
        <div class="action-section">
          <a href="{% url 'accounts.access_status' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-cog"></i>
            Complete Setup
          </a>
        </div>
      {% endif %}
    {% else %}
      <div class="signin-prompt mb-6">
        <p class="text-secondary mb-4">
          You need to sign in to access technical content and resources.
        </p>
        <div class="d-flex gap-3 justify-content-center">
          <a href="{% url 'accounts.login' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-sign-in-alt"></i>
            Sign In
          </a>
          <a href="{% url 'accounts.signup' %}" class="btn btn-secondary btn-lg">
            <i class="fas fa-user-plus"></i>
            Create Account
          </a>
        </div>
      </div>
    {% endif %}
    
    <!-- Information Section -->
    <div class="info-section mt-8">
      <div class="info-card">
        <h4>Why is approval required?</h4>
        <p>TechBookHub provides access to premium technical content and resources. 
           Administrator approval ensures that access is granted to legitimate users 
           who will benefit from our technical library.</p>
      </div>
    </div>
  </div>
</div>

<!-- Access Request Modal -->
{% if user.is_authenticated and access_context.can_request_access %}
<div id="accessRequestModal" class="modal">
  <div class="modal-content">
    <div class="modal-header text-center mb-6">
      <div class="modal-icon">
        <i class="fas fa-paper-plane"></i>
      </div>
      <h3>Request Content Access</h3>
      <p>Submit a request to access technical books and resources.</p>
    </div>
    
    <form id="accessRequestForm">
      {% csrf_token %}
      <div class="form-group mb-4">
        <label for="requestMessage" class="form-label">
          Message (Optional)
        </label>
        <textarea 
          id="requestMessage" 
          name="message" 
          class="form-control" 
          rows="4" 
          placeholder="Tell us why you'd like access to our technical content..."></textarea>
      </div>
      
      <div class="modal-actions d-flex gap-3 justify-content-center">
        <button type="button" id="cancelRequest" class="btn btn-secondary">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
          Submit Request
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<style>
.access-denied-section {
  max-width: 600px;
  margin: 0 auto;
  padding: var(--space-8) var(--space-4);
}

.access-denied-icon {
  width: 120px;
  height: 120px;
  background: var(--error-subtle);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  animation: pulse 2s ease-in-out infinite;
}

.access-denied-icon i {
  font-size: var(--font-size-4xl);
  color: var(--error);
}

.status-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  text-align: center;
}

.pending-card {
  border-color: var(--warning);
}

.rejected-card {
  border-color: var(--error);
}

.suspended-card {
  border-color: var(--error);
}

.status-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto var(--space-4);
}

.pending-card .status-icon {
  background: var(--warning-subtle);
}

.pending-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--warning);
}

.rejected-card .status-icon {
  background: var(--error-subtle);
}

.rejected-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--error);
}

.suspended-card .status-icon {
  background: var(--error-subtle);
}

.suspended-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--error);
}

.status-details {
  margin-top: var(--space-4);
  padding-top: var(--space-4);
  border-top: 1px solid var(--border-default);
}

.rejection-reason,
.suspension-reason {
  background: var(--error-subtle);
  color: var(--error);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  margin-top: var(--space-3);
}

.info-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  text-align: left;
}

.modal-icon {
  width: 80px;
  height: 80px;
  background: var(--accent-subtle);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto var(--space-4);
}

.modal-icon i {
  font-size: var(--font-size-3xl);
  color: var(--accent-primary);
}

@media (max-width: 768px) {
  .access-denied-section {
    padding: var(--space-6) var(--space-2);
  }
  
  .modal-actions {
    flex-direction: column !important;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const requestBtn = document.getElementById('requestAccessBtn');
  const modal = document.getElementById('accessRequestModal');
  const form = document.getElementById('accessRequestForm');
  const cancelBtn = document.getElementById('cancelRequest');
  
  if (requestBtn && modal) {
    requestBtn.addEventListener('click', function() {
      modal.style.display = 'block';
      setTimeout(() => {
        modal.style.opacity = '1';
        modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(1)';
      }, 10);
    });
    
    function hideModal() {
      modal.style.opacity = '0';
      modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(0.9)';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', hideModal);
    }
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideModal();
      }
    });
    
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        fetch('{% url "accounts.request_access" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            hideModal();
            location.reload();
          } else {
            alert(data.error || 'Failed to submit request');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to submit request');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        });
      });
    }
  }
});
</script>
{% endblock %}