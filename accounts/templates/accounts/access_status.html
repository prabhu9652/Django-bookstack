{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container p-8">
  <div class="access-status-section">
    <!-- Header -->
    <div class="page-header text-center mb-12">
      <div class="header-icon mb-4">
        <i class="fas fa-user-shield"></i>
      </div>
      <h1 class="mb-4">Account Access Status</h1>
      <p class="text-secondary">
        Manage your content access permissions and view request history
      </p>
    </div>
    
    <!-- Current Status Card -->
    <div class="status-overview mb-8">
      {% if access_status.is_approved %}
        <div class="status-card approved-card">
          <div class="status-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="status-content">
            <h3>Access Approved</h3>
            <p>You have full access to all technical content and resources.</p>
            <div class="status-details">
              <div class="detail-item">
                <strong>Approved:</strong> {{ access_status.approved_at|date:"M d, Y g:i A" }}
              </div>
              <div class="detail-item">
                <strong>Approved by:</strong> {{ access_status.approved_by.username }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Access Permissions -->
        <div class="permissions-grid mt-6">
          <div class="permission-item">
            <div class="permission-icon">
              <i class="fas fa-eye"></i>
            </div>
            <div class="permission-content">
              <h4>View Content</h4>
              <p>Browse and view all technical books</p>
            </div>
          </div>
          <div class="permission-item">
            <div class="permission-icon">
              <i class="fas fa-download"></i>
            </div>
            <div class="permission-content">
              <h4>Download PDFs</h4>
              <p>Download technical books for offline reading</p>
            </div>
          </div>
          <div class="permission-item">
            <div class="permission-icon">
              <i class="fas fa-bookmark"></i>
            </div>
            <div class="permission-content">
              <h4>Personal Library</h4>
              <p>Save books to your personal library</p>
            </div>
          </div>
          <div class="permission-item">
            <div class="permission-icon">
              <i class="fas fa-comments"></i>
            </div>
            <div class="permission-content">
              <h4>Write Reviews</h4>
              <p>Share your thoughts on technical books</p>
            </div>
          </div>
        </div>
        
      {% elif access_status.is_pending %}
        <div class="status-card pending-card">
          <div class="status-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="status-content">
            <h3>Access Pending</h3>
            <p>Your access request is being reviewed by an administrator.</p>
            <div class="status-details">
              <div class="detail-item">
                <strong>Requested:</strong> {{ access_status.requested_at|date:"M d, Y g:i A" }}
              </div>
              <div class="detail-item">
                <strong>Status:</strong> {{ access_status.get_status_display }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="pending-actions mt-6">
          <div class="info-card">
            <h4>What happens next?</h4>
            <ul>
              <li>An administrator will review your request</li>
              <li>You'll be notified of the decision via email</li>
              <li>Once approved, you'll have full access to content</li>
            </ul>
          </div>
        </div>
        
      {% elif access_status.is_rejected %}
        <div class="status-card rejected-card">
          <div class="status-icon">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="status-content">
            <h3>Access Rejected</h3>
            <p>Your access request has been reviewed and rejected.</p>
            {% if access_status.rejection_reason %}
              <div class="rejection-reason">
                <strong>Reason:</strong> {{ access_status.rejection_reason }}
              </div>
            {% endif %}
            <div class="status-details">
              <div class="detail-item">
                <strong>Requested:</strong> {{ access_status.requested_at|date:"M d, Y g:i A" }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="rejected-actions mt-6">
          <button id="requestAccessBtn" class="btn-request-access">
            <i class="fas fa-paper-plane"></i>
            Submit New Access Request
          </button>
        </div>
        
      {% elif access_status.is_suspended %}
        <div class="status-card suspended-card">
          <div class="status-icon">
            <i class="fas fa-ban"></i>
          </div>
          <div class="status-content">
            <h3>Access Suspended</h3>
            <p>Your access to content has been suspended.</p>
            {% if access_status.rejection_reason %}
              <div class="suspension-reason">
                <strong>Reason:</strong> {{ access_status.rejection_reason }}
              </div>
            {% endif %}
          </div>
        </div>
        
        <div class="suspended-info mt-6">
          <div class="info-card">
            <h4>Contact Administrator</h4>
            <p>If you believe this suspension is in error, please contact the administrator for assistance.</p>
          </div>
        </div>
      {% endif %}
    </div>
    
    <!-- Request History -->
    {% if recent_requests %}
    <div class="request-history">
      <h3 class="mb-4">Recent Access Requests</h3>
      <div class="requests-list">
        {% for request in recent_requests %}
          <div class="request-item">
            <div class="request-info">
              <div class="request-date">
                {{ request.requested_at|date:"M d, Y g:i A" }}
              </div>
              {% if request.message %}
                <div class="request-message">
                  "{{ request.message }}"
                </div>
              {% endif %}
            </div>
            <div class="request-status">
              {% if request.processed %}
                <span class="status-badge processed">
                  <i class="fas fa-check"></i>
                  Processed
                </span>
              {% else %}
                <span class="status-badge pending">
                  <i class="fas fa-clock"></i>
                  Pending
                </span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="quick-actions mt-8">
      <div class="actions-grid">
        <a href="{% url 'books.index' %}" class="action-card">
          <div class="action-icon">
            <i class="fas fa-books"></i>
          </div>
          <h4>Browse Books</h4>
          <p>Explore our technical library</p>
        </a>
        
        {% if access_context.has_content_access %}
          <a href="{% url 'library.index' %}" class="action-card">
            <div class="action-icon">
              <i class="fas fa-bookmark"></i>
            </div>
            <h4>My Library</h4>
            <p>View your saved books</p>
          </a>
        {% endif %}
        
        {% url 'roadmap:home' as roadmap_url %}
        <a href="{{ roadmap_url|default:'/roadmap/' }}" class="action-card">
          <div class="action-icon">
            <i class="fas fa-route"></i>
          </div>
          <h4>Career Roadmaps</h4>
          <p>Explore learning paths</p>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Access Request Modal -->
{% if access_context.can_request_access %}
<div id="accessRequestModal" class="modal">
  <div class="modal-content">
    <div class="modal-header text-center mb-6">
      <div class="modal-icon">
        <i class="fas fa-paper-plane"></i>
      </div>
      <h3>Request Content Access</h3>
      <p>Submit a request to access technical books and resources.</p>
    </div>
    
    <form id="accessRequestForm">
      {% csrf_token %}
      <div class="form-group mb-4">
        <label for="requestMessage" class="form-label">
          Message (Optional)
        </label>
        <textarea 
          id="requestMessage" 
          name="message" 
          class="form-control" 
          rows="4" 
          placeholder="Tell us why you'd like access to our technical content..."></textarea>
      </div>
      
      <div class="modal-actions d-flex gap-3 justify-content-center">
        <button type="button" id="cancelRequest" class="btn btn-secondary">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i>
          Submit Request
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<style>
.access-status-section {
  max-width: 800px;
  margin: 0 auto;
}

.header-icon {
  width: 80px;
  height: 80px;
  background: var(--accent-subtle);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
}

.header-icon i {
  font-size: var(--font-size-2xl);
  color: var(--accent-primary);
}

.status-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.approved-card {
  border-color: var(--success);
}

.pending-card {
  border-color: var(--warning);
}

.rejected-card {
  border-color: var(--error);
}

.suspended-card {
  border-color: var(--error);
}

.status-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.approved-card .status-icon {
  background: var(--success-subtle);
}

.approved-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--success);
}

.pending-card .status-icon {
  background: var(--warning-subtle);
}

.pending-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--warning);
}

.rejected-card .status-icon,
.suspended-card .status-icon {
  background: var(--error-subtle);
}

.rejected-card .status-icon i,
.suspended-card .status-icon i {
  font-size: var(--font-size-2xl);
  color: var(--error);
}

.status-content {
  flex: 1;
}

.status-details {
  margin-top: var(--space-3);
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}

.detail-item {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.rejection-reason,
.suspension-reason {
  background: var(--error-subtle);
  color: var(--error);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  margin-top: var(--space-3);
}

.permissions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--space-4);
}

.permission-item {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.permission-icon {
  width: 50px;
  height: 50px;
  background: var(--success-subtle);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.permission-icon i {
  font-size: var(--font-size-lg);
  color: var(--success);
}

.info-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
}

.info-card ul {
  margin-top: var(--space-3);
  padding-left: var(--space-4);
}

.info-card li {
  margin-bottom: var(--space-2);
  color: var(--text-secondary);
}

.requests-list {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.request-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-4);
  border-bottom: 1px solid var(--border-default);
}

.request-item:last-child {
  border-bottom: none;
}

.request-date {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.request-message {
  font-style: italic;
  color: var(--text-secondary);
  font-size: var(--font-size-sm);
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: 600;
}

.status-badge.processed {
  background: var(--success-subtle);
  color: var(--success);
}

.status-badge.pending {
  background: var(--warning-subtle);
  color: var(--warning);
}

.actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-4);
}

.action-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  text-align: center;
  text-decoration: none;
  color: inherit;
  transition: all var(--transition-normal);
}

.action-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--accent-primary);
  text-decoration: none;
  color: inherit;
}

.action-icon {
  width: 60px;
  height: 60px;
  background: var(--accent-subtle);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto var(--space-3);
}

.action-icon i {
  font-size: var(--font-size-xl);
  color: var(--accent-primary);
}

.modal-icon {
  width: 80px;
  height: 80px;
  background: var(--accent-subtle);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto var(--space-4);
}

.modal-icon i {
  font-size: var(--font-size-3xl);
  color: var(--accent-primary);
}

@media (max-width: 768px) {
  .status-card {
    flex-direction: column;
    text-align: center;
  }
  
  .permissions-grid {
    grid-template-columns: 1fr;
  }
  
  .actions-grid {
    grid-template-columns: 1fr;
  }
  
  .request-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-2);
  }
  
  .modal-actions {
    flex-direction: column !important;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const requestBtn = document.getElementById('requestAccessBtn');
  const modal = document.getElementById('accessRequestModal');
  const form = document.getElementById('accessRequestForm');
  const cancelBtn = document.getElementById('cancelRequest');
  
  if (requestBtn && modal) {
    requestBtn.addEventListener('click', function() {
      modal.style.display = 'block';
      setTimeout(() => {
        modal.style.opacity = '1';
        modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(1)';
      }, 10);
    });
    
    function hideModal() {
      modal.style.opacity = '0';
      modal.querySelector('.modal-content').style.transform = 'translate(-50%, -50%) scale(0.9)';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', hideModal);
    }
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideModal();
      }
    });
    
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        fetch('{% url "accounts.request_access" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            hideModal();
            location.reload();
          } else {
            alert(data.error || 'Failed to submit request');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to submit request');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        });
      });
    }
  }
});
</script>
{% endblock %}